# Active Context

## Current Focus
Implement chat history persistence.

## Recent Changes
- **Implemented Model Selection Persistence:** Used `vscode.getState()`/`setState()` in `App.tsx` to save and restore the last selected model ID across webview reloads.
- **Fixed Stream End Handling:** Added explicit `streamFinished` message from backend (`extension.ts`) to frontend (`App.tsx`) to reliably stop the UI streaming indicator.
- **Fixed State Synchronization:** Ensured Chat UI model list updates correctly after API key changes in Settings UI. (Triggered model re-fetch on provider status change in `App.tsx`).
- **Fixed Model List Refresh (`App.tsx`):**
    - Modified `useEffect` hook in `App.tsx` to re-trigger `getAvailableModels` message when `providerStatus` is updated (e.g., after setting/deleting an API key), ensuring the chat UI's model list reflects newly available providers.
- **Corrected Settings UI (`SettingPage.tsx`):** (Previous change)
    - Removed local `providerDetails`.
    - Updated component to render from `providerStatus` prop.
    - Updated filtering logic.
    - Fixed JSX comment issue.
- **Updated Backend Data Structure (`AiService.ts`, `extension.ts`):** (Previous change)
    - `AiService.getProviderStatus` returns richer `ProviderInfoAndStatus[]`.
    - `extension.ts` handlers updated for new structure.
- **Updated App State (`App.tsx`):** (Previous change)
    - `providerStatus` state holds `ProviderInfoAndStatus[]`.
    - Message handling updated.
- **Updated Settings UI (Initial Features):** (Previous change)
    - Added "Delete Key" button.
    - Added `handleDeleteApiKey` handler.
    - Added `apiKeyUrl` display.
    - Defined `providerDetails` locally (incorrectly).
- **Updated Extension (`extension.ts`):** (Previous change)
    - Added `deleteApiKey` handler.
    - Updated other handlers.
    - Imported `providerMap`.
- **Updated App (`App.tsx`):** (Previous change)
    - Updated message calls and props.
- **Updated Extension (`extension.ts`):**
    - Added message handler for `deleteApiKey`.
    - Updated handlers for `webviewReady`, `getProviderStatus`, `setApiKey` to use refactored `AiService` methods and `providerMap`.
    - Imported `providerMap`.
- **Updated App (`App.tsx`):**
    - Ensured `getProviderStatus` and `getAvailableModels` are called on `webviewReady`.
    - Passed necessary props to `SettingPage`.
- **Further Refactored AI Provider Logic:** (Previous change)
    - Modified `AiProvider` interface for key/status management.
    - Updated provider modules to implement the interface.
    - Refactored `AiService` to delegate key/status management.
    - Removed redundant properties/methods from `AiService`.
    - Updated methods in `AiService` to use provider methods.
    - Fixed `dynamicImport` path.
- **Refactored AI Provider Logic (Initial):** (Previous change)
    - Created `src/ai/providers` directory.
    - Defined initial `AiProvider` interface.
    - Created individual provider modules implementing the initial interface.
    - Implemented dynamic model fetching for OpenRouter.
    - Created `src/ai/providers/index.ts`.
    - Initial refactor of `AiService` (`_getProviderInstance`, `resolveAvailableModels`).
    - Removed old SDK imports and helpers.
    - Created `src/utils/dynamicImport.ts`.
- **Added Settings Provider Search:** (Previous change)
    - Added a search input field to `SettingPage.tsx`.
    - Implemented state (`searchQuery`) and filtering logic (`filteredProviders`, `useMemo`) to dynamically filter the displayed provider list based on the search query (matching name or key).
- **Implemented OpenRouter Model Fetching:** (Previous change)
    - Added `fetchOpenRouterModels` method to `AiService`.
    - Updated `resolveAvailableModels` to use the fetched models.
- **Implemented Settings API Key Input:** (Previous change)
    - Added UI elements and message handling for setting API keys in `SettingPage.tsx` and `src/extension.ts`.
- **Restored Settings Page:** (Previous change)
    - Updated `SettingPage.tsx` props and rendering logic.
    - Exported types from `App.tsx`.
    - Passed props in `App.tsx` route.
- **Added Nanostores:** (Previous change)
    - Installed `nanostores` and `@nanostores/preact` dependencies.
- **Added GSAP:** (Previous change)
    - Installed `gsap` dependency.
- **Integrated UnoCSS:** (Previous change)
    - Installed `unocss`, `@unocss/vite`, `@unocss/reset`.
    - Configured Vite (`webview-ui/vite.config.ts`).
    - Created UnoCSS config file (`webview-ui/uno.config.ts`).
    - Imported UnoCSS styles in `webview-ui/src/main.tsx`.
- **Implemented Routing:** (Previous change)
    - Installed `wouter`.
    - Created `SettingPage.tsx` and `ChatPage.tsx` components.
    - Updated `webview-ui/src/app.tsx` for routing.
    - Replaced settings modal with `/settings` route.
    - Updated `showSettings` message handler.
- **Relaxed Development CSP:** (Previous change)
    - Added `'unsafe-eval'` to the `script-src` directive in the development mode Content Security Policy within `src/extension.ts` (`getWebviewContent`). This was to test if Vite's HMR script execution was being blocked.
- **Fixed Vite Port File Path:**
    - Corrected the path used in `src/extension.ts` (`getWebviewContent`) to read the `.vite.port` file from the project root directory.
- **Fixed `package.json` Inconsistency:**
    - Updated `activationEvents`, `contributes.views`, and removed obsolete `menus`, `commands` to align with `WebviewViewProvider`. Resolved "No data provider registered" error.
- **Vite Port Discovery (Initial Implementation):**
    - Modified `webview-ui/vite.config.ts` to write the running dev server port to `.vite.port`.
    - Modified `src/extension.ts` to read the port during development.
- **Tool Refactoring & Expansion:** (Completed previously)
- **Fixed Stream Parsing (Comprehensive):** (Completed previously)
- **Removed Deprecated `StreamData`:** (Completed previously)
- **Standardized `streamText` Usage:** (Completed previously)
- **Corrected Stream Handling:** (Completed previously)
- **Corrected Stream Return Value:** (Completed previously)
- **UI Update (Tool Status):** (Completed previously, but status updates are now disabled).
- **AiService Refactoring:** (Completed previously)
- **Configuration Update:** (Completed previously)
- **Previous:** Project renamed to Zen Coder; Vercel AI SDK enhancements applied.
- **UI Tool Display Refinement:** (Completed previously)
- **`uuidGenerateTool` Enhancement & Progress:** (Completed previously)
- **Tool Result Handling Clarification:** (Completed previously)
- **Merged Settings UI into Chat Webview (Complete):** (Completed previously)

## Next Steps
- **Current Task:** Update Memory Bank and commit model persistence fix.
- **Next:** Implement chat history persistence.
- **Previous:** Modify `App.tsx` to re-fetch models on status change.
- **Future:** Implement model selection persistence in Chat UI.
- **Future:** Implement model selection persistence in Chat UI.
- **Future:** Implement chat history persistence.
- **Future:** Consider applying progress update pattern to other tools.
- **Future:** Consider refining UI display for complex tool results.
## Debugging Notes
- **Model Selection Persists:** Last selected model is now saved and restored using webview state API.
- **Streaming Indicator Fixed:** Added explicit `streamFinished` message handling to ensure UI stops indicating streaming reliably.
- **Model List Refresh Fixed:** Chat UI model list now updates automatically after API keys are set/deleted in Settings.
- **Settings UI Corrected:** Uses backend data for provider details (Previous).
- **Backend Communication Updated:** Sends richer provider info list (Previous). Handles delete key message (Previous).
- **AI Provider Logic Further Refactored:** `AiService` delegates key/status management (Previous).
- **OpenRouter Models Fetched Dynamically:** Logic in `openRouterProvider.ts` (Previous).
- **Settings Provider Search Added:** Users can now filter the provider list in the settings page (Previous).
- **API Key Input Added:** Settings page allows setting API keys (Previous).
- **Settings Page Restored:** Moved rendering logic and passed necessary props (Previous).
- **Nanostores Added:** Installed the library and Preact integration (Previous).
- **GSAP Added:** Installed the library (Previous).
- **UnoCSS Integrated:** Added dependencies, Vite plugin, config, and imports (Previous).
- **Routing Implemented:** Added `wouter` and page components (Previous).
- **Relaxed Dev CSP:** Added `'unsafe-eval'` to `script-src` for testing HMR compatibility (Previous).
- **Fixed Vite Port File Path:** Corrected path in `src/extension.ts`.
- **Fixed "No data provider registered" Error:** Resolved by correcting `package.json`.
- **Fixed Vite 504 Error (Chat UI):** (Resolved previously)
- **Fixed Chat UI Hang:** (Resolved previously)
- **Fixed `getCurrentModelId` Return Type:** (Resolved previously)
- **Added Debug Logs (API Keys):** (Kept)
- **Verified Model Resolver Logic:** (Kept)
- **Corrected `_getProviderInstance` Logic:** (Kept)
- **Activity Bar Entry:** Changed to direct Webview View.
- **Verified Chat UI Code:** (Kept)

## Active Decisions
- Prioritized fixing core stream parsing and removing deprecated API usage.
- Standardized on documented Vercel AI SDK APIs.
- **New Principle:** Tools should support batch operations.
- Prioritized human-readable, inline tool status summaries.
- Confirmed tool results are passed back to the AI.
- Used `vscode.getState/setState` for simple webview state persistence (model selection).
- Added explicit `streamFinished` message from backend to UI to fix streaming indicator persistence.
- Added logic to `App.tsx` to re-fetch models when provider status changes.
- Corrected `SettingPage.tsx` to use backend data structure (Previous).
- Updated `AiService` and `extension.ts` for combined provider info (Previous).
- Updated `App.tsx` state management (Previous).
- Updated Settings UI (`SettingPage.tsx`) to add delete/URL features (Previous).
- Updated backend message handling (`extension.ts`) for UI changes (Previous).
- Delegated API key and status management to provider modules (Previous).
- Refactored AI provider handling into modular components (Initial refactor).
- Added search functionality to the Settings page Provider list (Previous).
- Implemented dynamic fetching of OpenRouter models (Moved to provider module).
- Implemented API Key input and setting mechanism in the Settings page (Previous).
- Restored Settings page functionality after routing refactor (Previous).
- Added Nanostores for state management (Previous).
- Added GSAP for animations (Previous).
- Integrated UnoCSS for utility-first styling (Previous).
- Replaced Settings modal with a dedicated `/settings` route using `wouter` (Previous).
- Refactored activation to use `WebviewViewProvider` (Previous).
- Implemented Vite port discovery (Previous).
- Corrected `package.json` contributions (Previous).
- Corrected Vite port file path (Previous).
- Relaxed development CSP for testing (Previous).